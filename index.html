<!DOCTYPE html>
<html>
<head>
    <title>Cosmic Genesis Simulation (r172)</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #info { position: absolute; top: 10px; left: 10px; color: white; font-family: Arial, sans-serif; }
    </style>
</head>
<body>
    <div id="info">COSMIC GENESIS SIMULATION - TIME SINCE BIG BANG: <span id="time">0</span> MY</div>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.172.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.172.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { FilmPass } from 'three/addons/postprocessing/FilmPass.js';

let scene, camera, renderer, composer;
let particles, positions, velocities, colors;
let startTime = Date.now();
let universeAge = 0;
const PARTICLE_COUNT = 50000;

init();
animate();

function init() {
    // Scene setup
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    
    renderer = new THREE.WebGLRenderer({ 
        antialias: true,
        powerPreference: "high-performance",
        stencil: false
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Post-processing chain
    composer = new EffectComposer(renderer);
    const renderPass = new RenderPass(scene, camera);
    composer.addPass(renderPass);

    const bloomPass = new UnrealBloomPass(
        new THREE.Vector2(window.innerWidth, window.innerHeight),
        1.5, 0.4, 0.85
    );
    composer.addPass(bloomPass);

    const filmPass = new FilmPass(0.35, 0.025, 648, false);
    composer.addPass(filmPass);

    // Particle system initialization
    const geometry = new THREE.BufferGeometry();
    positions = new Float32Array(PARTICLE_COUNT * 3);
    velocities = new Float32Array(PARTICLE_COUNT * 3);
    colors = new Float32Array(PARTICLE_COUNT * 3);

    // Create initial singularity
    for(let i = 0; i < PARTICLE_COUNT * 3; i += 3) {
        positions[i] = 0;
        positions[i+1] = 0;
        positions[i+2] = 0;

        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos((Math.random() * 2) - 1);
        const speed = 0.1 + Math.random() * 0.3;
        
        velocities[i] = Math.sin(phi) * Math.cos(theta) * speed;
        velocities[i+1] = Math.sin(phi) * Math.sin(theta) * speed;
        velocities[i+2] = Math.cos(phi) * speed;

        colors[i] = 1.0;
        colors[i+1] = 1.0;
        colors[i+2] = 1.0;
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

    const material = new THREE.PointsMaterial({
        size: 0.1,
        vertexColors: true,
        transparent: true,
        blending: THREE.AdditiveBlending,
        sizeAttenuation: true
    });

    particles = new THREE.Points(geometry, material);
    scene.add(particles);

    // Lighting configuration
    const light = new THREE.PointLight(0xffffff, 10, 100);
    light.position.set(0, 0, 0);
    scene.add(light);
    scene.environmentIntensity = 0.5;

    // Camera positioning
    camera.position.z = 5;
    camera.rotation.x = -Math.PI / 4;

    // Window resize handler
    window.addEventListener('resize', onWindowResize, false);
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    composer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    
    const time = (Date.now() - startTime) / 1000;
    universeAge = time * 500;
    document.getElementById('time').textContent = Math.floor(universeAge);

    // Update particle system
    const positions = particles.geometry.attributes.position.array;
    const colors = particles.geometry.attributes.color.array;
    
    for(let i = 0; i < PARTICLE_COUNT * 3; i += 3) {
        positions[i] += velocities[i] * time;
        positions[i+1] += velocities[i+1] * time;
        positions[i+2] += velocities[i+2] * time;

        const distance = Math.sqrt(
            positions[i]**2 + positions[i+1]**2 + positions[i+2]**2
        );
        
        // Color transition based on distance
        const hue = 0.6 + distance * 0.05;
        const saturation = 1 - Math.min(distance * 0.1, 0.8);
        const color = new THREE.Color().setHSL(hue, saturation, 0.5);
        
        colors[i] = color.r;
        colors[i+1] = color.g;
        colors[i+2] = color.b;
    }

    particles.geometry.attributes.position.needsUpdate = true;
    particles.geometry.attributes.color.needsUpdate = true;

    // Camera animation
    camera.position.z = 5 + time * 0.5;
    camera.position.y = Math.sin(time * 0.3) * 2;
    camera.lookAt(scene.position);

    // Render with post-processing
    composer.render();
}

// Interactive camera controls
let mouseDown = false;
let mouseX = 0;
let mouseY = 0;

document.addEventListener('mousedown', (e) => {
    mouseDown = true;
    mouseX = e.clientX;
    mouseY = e.clientY;
});

document.addEventListener('mouseup', () => {
    mouseDown = false;
});

document.addEventListener('mousemove', (e) => {
    if(mouseDown) {
        const deltaX = e.clientX - mouseX;
        const deltaY = e.clientY - mouseY;
        
        camera.position.x += deltaX * 0.01;
        camera.position.y -= deltaY * 0.01;
        camera.lookAt(scene.position);
        
        mouseX = e.clientX;
        mouseY = e.clientY;
    }
});
</script>
</body>
</html>
